<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,width=device-width">

  <title>Asian Games GBK</title>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      z-index: -1;
    }

    p {
    padding: 0px 0px 0px 35px;
    line-height: 2;
    }

    #navDiv {
      position: absolute;
      bottom: 100px;
      left: 50px;
      width: 120px;
      height: 120px;
      border: 1px solid white;
      z-index: 1;
    }
    #tempDiv {
      position: absolute;
      font-family: 'Lato', sans-serif;
      letter-spacing: 0.4px;
      bottom: 116px;
      left: 195px;
      z-index: 1;

    }
    #titleDiv {
      position: absolute;
      font-family: 'Lato', sans-serif;
      letter-spacing: 0.4px;
      top: 36px;
      left: 350px;
      z-index: 1;
      font-size: 150%;
      border-left: 1px solid black;
      padding: 10px;

    }

    #logo {
      position: absolute;
      top:15px;
      left: 35px;
      z-index: 1;
    }


  </style>


  <link href="https://fonts.googleapis.com/css?family=Lato:300" rel="stylesheet">
  <link rel="stylesheet" href="https://js.arcgis.com/4.7/esri/css/main.css">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <script src="https://js.arcgis.com/4.7/"></script>


  <script>
    require([
      "esri/WebScene",
      "esri/views/SceneView",
      "esri/views/MapView",
      "esri/WebMap",

      "esri/tasks/support/Query",
      "esri/views/ui/DefaultUI",
      "esri/widgets/Home",
      "esri/layers/FeatureLayer",
      "esri/PopupTemplate",

      "dojo/dom",
      "dojo/on",
      "dojo/domReady!"
    ], function(WebScene, SceneView, MapView, WebMap, Query, dom, on, PopupTemplate, DefaultUI, Home, FeatureLayer) {

//-------------------------------------- loading agol stuff -------------------------------------------

    // load web scene from ArcGIS Online
      var webScene = new WebScene({
        portalItem: { // autocasts as new PortalItem()
          id: "d7adce2634974cdd9078ba990123736d"
        }
      });

    // create the scene view
      var view = new SceneView({
        container: "viewDiv",
        map: webScene,

        padding: {
          top: 120,
          bottom: 0,
          right: 25,
          left: 25
        },
        environment: {
          lighting: {
            ambientOcclusionEnabled: true
          }
        }
      });


      view.popupManager.enabled = true;

      view.popup.dockOptions = {
        // Disable the dock button so users cannot undock the popup
        buttonEnabled: false,
        // Dock the popup when the size of the view is less than or equal to 600x1000 pixels
        breakpoint: {
          width: 600,
          height: 1000
        }
      };



// -------------------- Scene set up done, now the other stuff --------------------------

    // set up point style for Cabang Olahraga


    // set up renderer for venue
            var venueRenderer = {
                  type: "simple",
                    symbol: {
                      type: "mesh-3d" ,
                      symbolLayers: [{
                        type: "fill",
                        material: {
                          color: "#ffffff",
                          colorMixMode: "replace"
                        },
                        edges: {
                          type: 'solid',
                          color: [102, 102, 102],
                          size: 0.5
                        }
                      }]
                    }
                  };

// ------------------- interacting with webscene -------------------------------

   // wait until the webscene finished loading
      webScene.when(function() {

        // retrieve the scene layer from the webscene
        var venues =  webScene.layers.find(function(l) {
           return l.title === "3DVenues";
         });

         var sports =  webScene.layers.find(function(l) {
            return l.title === "Sports";
          });
          sports.elevationInfo = {
            mode: "relative-to-scene"
          };

          venues.renderer = venueRenderer;
          //sports.renderer = pointsRenderer;

      // set popup for Cabang Olahraga
          sports.popupTemplate = {
            title: "<img src='{URL}' alt=''width=24 height=24>" + "<font size=6> {Cabor} </font>",
            content: "<p><font size=2.5> Venue: {Venue} <br> Capacity: <br> Phase: {Phase}  <br><br><img src='{Schedule}' alt=''width=85% height=85%> <br> <a href= '{TechBook}' target='_blank'>View Technical Handbook </a> </font></p>" };

// adding interaction when clicked
        // on click
          view.whenLayerView(venues)
            .then(function(sceneLayerView) {

              view.on("click", function(event) {
                view.hitTest(event)
                  .then(function(response) {

        // if 3D venue is clicked
                    if (response.results[0].graphic.layer.title === "3DVenues") {

                    console.log(response.results[0].graphic
                          .attributes.OBJECTID);

                      var query = new Query({
                        objectIds: [response.results[0].graphic
                          .attributes.OBJECTID
                        ],
                        outFields: ["*"]
                      });

       // query for 3D venue
                      sceneLayerView.queryExtent(query)
                        .then(function(result) {
                          view.goTo({
                            target: result.extent.expand(1),
                            tilt: 70,
                            zoom:18
                          }, {
                            duration: 1000,
                            easing: "out-expo"
                          });
                        });

                      sceneLayerView.queryFeatures(query)
                        .then(function(result) {

                          // log for venue name
                          console.log(result.features[0].attributes.Name);
                          // log for GBK website
                          console.log(result.features[0].attributes.Link);

                          });

     // if sport point is clicked instead
                    } if (response.results[0].graphic.layer.title === "Sports") {



                      // log link for technical handbook
                      console.log(response.results[0].graphic
                        .attributes.TechBook);

                      // log link to logo
                        console.log(response.results[0].graphic
                          .attributes.URL);
                    }


                  });
              })      // end of view.on click
            });     // end of when venue layer is shown
      });         // end of webScene

      //var homeBtn = new Home({
        //     view: view
          // });

           // Add the home button to the top left corner of the view
      //view.ui.add(homeBtn, "top-left");

    });
  </script>

  <script>
    require([
        "esri/Map",
        "esri/views/MapView",
        "esri/WebMap",
        "esri/layers/FeatureLayer",
        "dojo/domReady!"

      ],
      function(
        Map, MapView,
        WebMap,
        FeatureLayer
      ) {

        var navmap = new WebMap({
        portalItem: { // autocasts as new PortalItem()
          id: "8c195fcec6634b25b2302dcda07995f3"
        }
      });

        var navview = new MapView({
          container: "navDiv",
          map: navmap,

          //center: [ 106.8428588,-6.2498348],
          //zoom:10
        });

        navview.popup = true;


         var renderer = {
           type: "simple", // autocasts as new SimpleRenderer()
           symbol: {
             type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
             size: 3,
             color: "#fff6dd",
             outline: { // autocasts as new SimpleLineSymbol()
               color: [255, 196, 17, 0.4], // autocasts as new Color()
               width: 4             }
           }
         };

        var weather = new FeatureLayer({
          url: "http://13.76.3.201/asian_games_realtime/FeatureServer/0",
          renderer: renderer,
          definitionExpression: "kota = 'Jakarta Pusat'",
          mode: FeatureLayer.MODE_ONDEMAND,
          refreshInterval: 0.3, //Set the interval to 1 minute

        });

        weather.outFields = ["*"];
        navmap.add(weather);
        navview.ui.components = [];

        //--------- interactivity



        navview.whenLayerView(weather).then(function(layerView){
            layerView.watch("updating", function(val){
              if(!val){  // wait for the layer view to finish updating
                layerView.queryFeatures().then(function(results){
                  console.log(results[0].attributes);  // prints all the client-side graphics to the console

                  var temparature =  document.getElementById("tempDiv");
                  temparature.innerHTML = "<font size= 8> <b>" + results[0].attributes.tt_air_avg + " °C </b></font>" +
                                          "<font size= 3><br> Max: " + results[0].attributes.tt_air_max + " °C " + "|  Min: " + results[0].attributes.tt_air_min + " °C<br>" +
                                          "Wind Speed: " + results[0].attributes.ws_max + "km/h |  " + results[0].attributes.wd_card_EN ;
                });
              }
            });
          });


      });
  </script>

</head>

<body>
  <div id="viewDiv"></div>
  <div id="navDiv"></div>
  <div id="tempDiv"></div>
  <div id="titleDiv"> <b> Gelora Bung Karno Sport Complex Guide </b></div>
  <div id="logo"><img src='https://en.asiangames2018.id/d3images/ml/ag2018-assets/logo--desktop.svg' alt=''width=160% height=150%></div>


</html>
